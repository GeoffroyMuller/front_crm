<template>
  <Page
    title="Monorepo"
    icon="check_circle"
    v-model:sidebarOpen="sidebarOpen"
    :tabs="[
      {
        id: 'overview',
        title: $t('pages.projects.overview'),
      },
      {
        id: 'list',
        title: $t('pages.projects.list'),
      },
      {
        id: 'kanban',
        title: $t('pages.projects.kanban'),
      },
      /* {
        id: 'calendar',
        title: 'Calendrier',
      },
      {
        id: 'gantt',
        title: 'Gantt',
      },
      {
        id: 'timeline',
        title: 'Timeline',
      },
      {
        id: 'timeqsdline',
        title: 'Timeline',
      },
      {
        id: 'timeline',
        title: 'Timeline',
      },*/
    ]"
  >
    <Kanban
      v-model:columns="columns"
      @column-drag-start="drag = true"
      @element-drag-start="drag = true"
      @column-drag-end="drag = false"
      @element-drag-end="drag = false"
    >
      <template #section-end>
        <div class="h-input grid items-center">
          <Button variant="text" color="black" @click.stop="addColumn()">
            {{ $t("pages.projects.add-section") }}
          </Button>
        </div>
      </template>
      <template #title="{ column }">
        <Input
          v-model="column.title"
          variant="text"
          typo="title4"
          :id="getIdColumInputTitle(column.id)"
        />
      </template>
      <template #element="{ element }">
        <Card
          selectable
          class="p-4 min-h-[70px]"
          :class="{
            '!cursor-grab': drag,
          }"
          @click.stop="handleClickCard(element, $event)"
        >
          <div class="typo-title5">
            {{ element.title }}
          </div>
        </Card>
      </template>
      <template #column-footer="{ column }">
        <Button
          variant="text"
          class="m-auto mt-4"
          color="black"
          @click.stop="add(column)"
        >
          {{ $t("pages.projects.add-task") }}
        </Button>
      </template>
    </Kanban>
    <template #sidebar>
      <SidebarHead :actions="[]">
        <template #title>
          <Input
            variant="text"
            :model-value="selected?.title"
            @update:model-value="selected.title = $event"
            ref="titleInputRef"
            class="-ml-inputXPadding !h-12"
            typo="title2"
          />
        </template>
      </SidebarHead>
      <SidebarContent> </SidebarContent>
    </template>
  </Page>
</template>
<script lang="ts" setup>
import Page from "core/src/components/Page.vue";
import Kanban, { type KanbanColumns } from "core/src/components/Kanban.vue";
import Card from "core/src/components/card/Card.vue";
import Input from "core/src/components/form/Input.vue";
import Button from "core/src/components/Button.vue";
import SidebarHead from "core/src/components/sidebar/SidebarHead.vue";
import SidebarContent from "core/src/components/sidebar/SidebarContent.vue";
import { watch, ref, nextTick, inject } from "vue";
import { omitBy } from "lodash";
import { useRouter, useRoute } from "vue-router";

const contentRef = inject("page-content-ref");

type DemoKanbanColmun = {} & KanbanColumns<any>;

const { id } = useRoute().params;

function getIdColumInputTitle(idColumn: string | number) {
  return `kanban-project-${id}-column-${idColumn}-title-input`;
}

const COLUMNS_DEFAULTS = [
  {
    id: 0,
    title: "A faire 📋",
    elements: [
      {
        id: 0,
        title: "Faire le kanban",
      },
      {
        id: 1,
        title: "Faire buttons",
      },
    ],
  },
  {
    id: 1,
    title: "En cours 💻👨‍💻",
    elements: [
      {
        id: 2,
        title: "Fix form",
      },
      {
        id: 3,
        title: "Fix carousel",
      },
    ],
  },
  {
    id: 2,
    title: "Terminé 👌",
    elements: [],
  },
];

const selected = ref<DemoKanbanColmun["elements"][0]>();
const sidebarOpen = ref(false);
const drag = ref(false);
const titleInputRef = ref();

function handleClickCard(card: DemoKanbanColmun["elements"][0], event: Event) {
  sidebarOpen.value = true;
  selected.value = card;
  console.error(contentRef.value);
  console.error(event.target.getBoundingClientRect());
}

const columns = ref<DemoKanbanColmun[]>(COLUMNS_DEFAULTS);

function add(column: DemoKanbanColmun) {
  const index = columns.value.findIndex((c) => c.id === column.id);

  if (index != -1) {
    columns.value[index].elements.push({
      id: Math.random(),
      title: "",
    });
    selected.value =
      columns.value[index].elements[columns.value[index].elements.length - 1];
    sidebarOpen.value = true;
    titleInputRef?.value?.$refs?.internalRef?.focus();
  }
}

function addColumn() {
  const idColumn = Math.random();
  columns.value.push({
    id: idColumn,
    title: "",
    elements: [],
  });
  nextTick(() => {
    const inputTitle = document.getElementById(getIdColumInputTitle(idColumn));
    if (inputTitle != null) {
      inputTitle.focus();
    }
  });
}

function checkIfSelectedIsEmptyAndDelete(
  element?: DemoKanbanColmun["elements"][0]
) {
  const elem = element ?? selected.value;
  const selectedPurged = omitBy(
    elem,
    (k) => k == null || (typeof k === "string" && k.trim() === "")
  );
  if (Object.keys(selectedPurged).length === 1) {
    columns.value.forEach((c, i) => {
      const index = c.elements.findIndex((e) => e.id === elem.id);
      if (index != -1) {
        columns.value[i].elements = columns.value[i].elements.filter(
          (e, i) => i !== index
        );
      }
    });
  }
}

watch(
  () => sidebarOpen.value,
  () => {
    if (!sidebarOpen.value) {
      checkIfSelectedIsEmptyAndDelete();
    }
  }
);
watch(
  () => selected.value,
  (val, old) => {
    checkIfSelectedIsEmptyAndDelete(old);
  }
);
</script>
